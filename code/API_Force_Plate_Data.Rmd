---
title: "Force_Plate_API_Access"
output: html_document
date: "2025-09-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# install.packages("devtools")
```{r}
devtools::install_github("HawkinDynamics/hawkinR")
```

# Get Access - - - - -

# This function only needs to be executed 1 time and provides access for 1 hour

# The `region` parameter is default to "Americas", and does not need to be included if your site is in this region. Other regions ("Europe", "Asia/Pacific") would need to specify

# Input your secret integration key where I have 'secretKey'

```{r}
library(hawkinR)
library(tidyverse)
library(dplyr)
library(purrr)
library(lubridate)
library(stringr)
get_access('vPKBLq.le5HM5LYjRerJE5nDuSo8MPuEo5v7', region = "Americas")
testIds <- get_testTypes()
Roster <- get_athletes()
```

```{r}
group_df <- data.frame(
  groupID = c(
    "ZUggAD2tJyLQdTjY5NC6",
    "j7GJYC1D2R72qkhRLSMV",
    "v8lRGzQzaRVZu5ScFxZ9",
    "5drTQUE0JqiSKGqZfjiR",
    "EErrhFxsWhCZXFO18T4s",
    "uPgSmiAsqw9z4eh17UPy",
    "SBARyfjhwleDYrYD5kad",
    "oRiGgTKIXQs8nbr8tdia",
    "DkSNuDeSUf3dVtbowSyj",
    "RmMlgDN2eOWtHZm1Zw68",
    "Vi50x7AlYJy5QXrtldlq",
    "8HmVZQXeWQIfN4A2RKtU",
    "B9ygsEAXT8ncCiT21ETn",
    "1vId55SVdTL35jUpTSZv",
    "joDghgbjPc9jSSADHh5B",
    "fOZyq6AP3Lzbcwmpj10P",
    "kHSiV4I9tBSSl6RKWwJo"
  ),
  team = c(
    "Football",
    "Men's Soccer",
    "Men's Basketball",
    "Baseball",
    "Men's Tennis",
    "Golf",
    "Softball",
    "Men's Lacrosse",
    "Field Hockey",
    "Women's Tennis",
    "Women's Lacrosse",
    "Women's Soccer",
    "Volleyball",
    "Women's Basketball",
    "Women's Dive",
    "Men's Dive",
    "Women's Fencing"
  ),
  stringsAsFactors = FALSE
)
```

```{r}
# --- Date window (local tz) ---
start_local <- as_datetime("2024-08-01 00:00:00", tz = "America/New_York")
end_local   <- as_datetime("2025-05-31 23:59:59", tz = "America/New_York")

# --- CMJ id from your testIds tibble ---
cmj_type_id <- testIds %>%
  filter(str_to_lower(name) == "countermovement jump" | abbreviation == "CMJ") %>%
  pull(canonicalId) %>% .[1]

# --- Minimal wrapper that calls get_tests() with only the group id ---
get_tests_all <- function(gid) {
  fn  <- hawkinR::get_tests
  fml <- names(formals(fn))
  args <- list()
  for (nm in c("group_id","groupId","group","groupID","gid")) {
    if (nm %in% fml) { args[[nm]] <- gid; break }
  }
  # If no group arg is found, just call with no args (some builds return org-wide)
  tryCatch(do.call(fn, args), error = function(e) tibble(.error = conditionMessage(e)))
}

# --- Helpers to find column names in returned data ---
get_time_col <- function(df) {
  candidates <- c("performedAt","performedDateTime","timestamp","createdAt","time","testTime")
  intersect(candidates, names(df))[1]
}
get_testtype_col <- function(df) {
  candidates <- c("testTypeId","test_type_id","testTypeCanonicalId",
                  "test_type_canonical_id","canonicalTestTypeId")
  intersect(candidates, names(df))[1]
}

# --- Pull EVERYTHING first for each team ---
raw_all <- map_dfr(group_df$groupID, ~{
  dat <- get_tests_all(.x)
  if (!is.data.frame(dat) || nrow(dat) == 0) return(tibble())
  dat %>% mutate(groupID = .x)
}) %>%
  left_join(group_df, by = "groupID")


# --- Filter to CMJ, convert timestamp, and keep only Aug 2024 - May 2025 ----

start_dt <- as_datetime("2024-08-01 00:00:00", tz = "America/New_York")
end_dt   <- as_datetime("2025-05-31 23:59:59", tz = "America/New_York")

cmj_only <- raw_all %>%
  filter(testType_name == "Countermovement Jump") %>%
  mutate(
    performed_at_utc   = as_datetime(as.numeric(timestamp), tz = "UTC"),
    performed_at_local = with_tz(performed_at_utc, "America/New_York"),
    performed_date     = as_date(performed_at_local)
  ) %>%
  filter(performed_at_local >= start_dt & performed_at_local <= end_dt)

# ---- Clean and rename columns ----
cmj_clean <- cmj_only %>%
  rename(Organizations = team) %>%  # matches your ProblemDate table
  select(
    Organizations, athlete_id, athlete_name, segment, testType_name,
    performed_at_local, performed_date, everything(), -timestamp,
    -athlete_teams, -athlete_groups,
    -testType_tags_id, -testType_tags_name, -testType_tags_desc
  ) %>%
  mutate(
    performed_at_local = format(performed_at_local, "%Y-%m-%d %H:%M:%S")
  )

# Quick sanity check BEFORE writing
names(cmj_clean)
summary(range(cmj_clean$performed_date))

# ---- Write as CSV ----
library(readr)
write_csv(cmj_clean, "C:/Users/jordy/Documents/CMJ_Aug2024_May2025.csv")

# ---- Read it back cleanly ----
cmj_check <- read_csv(
  "C:/Users/jordy/Documents/CMJ_Aug2024_May2025.csv",
  col_types = cols(
    performed_at_local = col_datetime(format = "%Y-%m-%d %H:%M:%S"),
    performed_date = col_date()
  )
)

# Verify that columns are present and correct
names(cmj_check)
head(cmj_check)
```

```{r}
# checking dates and that only the cmj data has been pulled

# counting the test types
cmj_only %>% count(testType_name)

# checking the data range
range(cmj_only$performed_at_local)

# teams present 
unique(cmj_only$team)
```




